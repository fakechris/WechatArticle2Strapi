# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

Enhanced Article Extractor is a Chrome extension that extracts articles from web pages (especially WeChat articles) and saves them to Strapi CMS. The extension uses advanced content extraction powered by the Defuddle library (same engine as Obsidian Clipper) and features automatic image upload, anti-extension interference protection, and rich metadata extraction.

## Build Commands

```bash
# Development build with file watching
npm run dev

# Production build
npm run build

# Clean build files
npm run clean

# Install dependencies
npm install
```

## CLI Usage

```bash
# Extract article using CLI (creates draft in Strapi v4)
node cli/bin/cli_v2.js <url> --strapi

# With additional options
node cli/bin/cli_v2.js <url> --strapi --upload-images --head-image

# Examples
node cli/bin/cli_v2.js "https://mp.weixin.qq.com/s/..." --strapi --verbose
```

## Project Structure

- `src/` - Source code
  - `background.js` - Service worker for API calls and data processing
  - `popup.js` - Extension popup UI logic
  - `content-bundled.js` - Content script (bundled with Defuddle)
  - `options.js` - Settings page logic
- `cli/` - Command line interface
  - `bin/cli_v2.js` - Main CLI entry point with Playwright adapter
  - `src/adapters/playwright-adapter.js` - Playwright-based content extraction
  - `src/config.js` - Configuration management
- `shared/` - Shared code between extension and CLI
  - `core/integrations/strapi-integration.js` - Unified Strapi API integration
  - `utils/` - Utility functions (URL validation, slug generation, etc.)
- `dist/` - Built extension files (generated by webpack)
- `manifest.json` - Chrome extension manifest
- `webpack.config.js` - Build configuration

## Architecture

The project supports both Chrome Extension and CLI modes:

### Chrome Extension (Manifest V3)
1. **Content Script** (`content-bundled.js`) - Runs on web pages, extracts content using Defuddle engine
2. **Background Script** (`background.js`) - Handles Strapi API calls, image uploads, data processing
3. **Popup** (`popup.js`) - User interface for content preview and extraction
4. **Options** (`options.js`) - Configuration interface for Strapi connection settings

### CLI Mode
1. **CLI Entry** (`cli/bin/cli_v2.js`) - Command line interface with Playwright support
2. **Playwright Adapter** (`cli/src/adapters/playwright-adapter.js`) - Headless browser content extraction
3. **Shared Integration** (`shared/core/integrations/strapi-integration.js`) - Unified Strapi API logic

## Key Technical Details

### Content Extraction Engine
- Uses Defuddle library (same as Obsidian Clipper) for high-quality content extraction
- Fallback to WeChat-specific selectors for compatibility
- Anti-extension interference system to prevent other extensions from polluting extracted content

### Image Processing
- Automatic head image upload to Strapi media library
- Smart image filtering and relevance detection
- Base64 encoding for cross-domain image access

### Strapi Integration
- REST API integration with configurable endpoints
- Automatic slug generation using the `slug` library
- Field mapping system for flexible Strapi schema support
- **Draft Mode Support**: Articles are created as drafts by default in Strapi v4 (both CLI and Editor modes)
  - Uses dual strategy: removes `publishedAt` field + `?status=draft` query parameter
  - Fallback mechanism ensures compatibility across different Strapi v4 versions
  - **Field Mapping**: Uses `.articlerc.json` configuration for proper field name mapping to Strapi schema
  - **Security Architecture**: Browser communicates only with local proxy server, never directly with Strapi

### Build System
- Webpack 5 for bundling Node.js modules for browser environment
- Fallback configurations for Node.js modules (path, fs, crypto, etc.)
- Copy plugin for static assets and manifest transformation

## Development Workflow

1. Make changes to source files in `src/`
2. Run `npm run dev` for development with file watching
3. Load unpacked extension from `dist/` folder in Chrome
4. Use `npm run build` for production builds

## Important Files to Understand

- `src/background.js:5-28` - Image upload functionality
- `src/background.js:30-50` - Content sanitization and extension UI removal
- `shared/core/integrations/strapi-integration.js:228-232` - Draft mode implementation (removes publishedAt field)
- `shared/core/integrations/strapi-integration.js:1154-1201` - Draft endpoint strategy with fallback
- `editor/strapi-browser.js:52-103` - Editor draft mode implementation with field mapping
- `editor/server.cjs:198-222` - Field mapping endpoint serving .articlerc.json configuration
- `webpack.config.js:16-27` - Node.js module fallbacks for browser environment
- `manifest.json:24-31` - Content script configuration for early DOM injection

## Testing

Load the extension in Chrome via `chrome://extensions/` with Developer Mode enabled, then test on WeChat articles or other web pages. No automated test suite is currently configured.